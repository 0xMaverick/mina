{{ range $config := $.Values.archiveConfigs}}
{{- if $config.runPostgresDb }}
apiVersion: batch/v1
kind: Job
metadata:
  name: "{{ $config.name }}-db-bootstrap"
spec:
  template:
    spec:
      containers:
      - name: create-db
        image: bitnami/postgresql
        command: ["bash", "-c"]
        args: ["PGPASSWORD={{ $config.postgres.postgresqlPassword }} createdb --username {{ $config.postgres.postgresqlUsername }} --host {{ $config.postgres.postgresHost }} --port {{ $config.postgres.postgresPort }} --echo {{ $config.postgres.postgresDB }}"]
      - name: import-schema
        image: bitnami/postgresql
        command: ["bash", "-c"]
        args: ["PGPASSWORD={{ $config.postgresql.postgresqlPassword }} psql --username {{ $config.postgresql.postgresqlUsername }} --host {{ $config.postgres.postgresHost }} --port {{ $config.postgres.postgresPort }} --dbname {{ $config.postgres.postgresDB }} -f <(curl -Ls {{ $config.postgres.remoteSchemaFile }})"]
      - name: update-transaction-isolation-level
        image: bitnami/postgresql
        command: ["bash", "-c"]
        args: ["PGPASSWORD={{ $config.postgresql.postgresqlPassword }} psql --username {{ $config.postgresql.postgresqlUsername }} --host {{ $config.postgres.postgresHost }} --port {{ $config.postgres.postgresPort }} --dbname {{ $config.postgres.postgresDB }} -c ALTER DATABASE {{ $config.postgres.postgresDB }} SET DEFAULT_TRANSACTION_ISOLATION TO SERIALIZABLE ;"]
      restartPolicy: Never
  backoffLimit: 10
{{- end }}
{{- end }}